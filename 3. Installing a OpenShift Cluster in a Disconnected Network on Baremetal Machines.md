## 2.4 Quay Registry Configuration. 
 
Install podman and container-selinux packages for standalone registry

    [root@dc1fbreg01 ~]# yum module install container-tools:4.0 -y


Check podman and buildah version needed for Quay Mirror Registry as it needs podman version greater than 3.0

    [root@dc1fbreg01 ~]# skopeo -v
    skopeo version 1.6.2-maint

    [root@dc1fbreg01 ~]# podman version
    Client:       Podman Engine
    Version:      4.0.2
    API Version:  4.0.2
    Go Version:   go1.18.4
    Built:      Tue Aug 30 16:23:06 2022
    OS/Arch:    linux/amd64

    [root@dc1fbreg01 ~]# systemctl enable --now podman.socket podman.service

Install the Quay Mirror Registry

    [root@dc1fbreg01 ~]# mkdir /ocpregistry/mirror 
    [root@dc1fbreg01 ~]# cd /ocpregistry/mirror
    [root@dc1fbreg01 mirror]# tar xf mirror-registry.tar.gz -C /ocpregistry/mirror 
    [root@dc1fbreg01 mirror]# ./mirror-registry install --quayHostname dc1fbreg01.redprodc1.firebolt.para.in --quayStorage /ocpregistry --quayRoot /ocpregistry --initUser firebold --initPassword f!reb0lt! 

Certificate pem directory placement.

    [root@dc1fbreg01 ~]# cp /ocpregistry/quay-config/rootCA.pem /etc/pki/ca-trust/source/anchors/
    [root@dc1fbreg01 ~]# update-ca-trust 

Quay login testing 

    [root@dc1fbreg01 ~]# podman login dc1fbreg01.redprodc1.firebolt.para.in:8443 

Extract pull-secret from quay mirror registry. 

    [root@dc1fbreg01 ~]# podman login dc1fbreg01.redprodc1.firebolt.para.in:8443 --authfile quay-secret.json
    [root@dc1fbreg01 ~]# cat quay-secret.json | jq . -c 
    [root@dc1fbreg01 ~]# mkdir .docker 
    [root@dc1fbreg01 ~]# cp quay-secret.json .docker/config

Setting up variables requirements for ocp images

    [root@dc1fbreg01 ~]# vim openshift-vars.sh 
    export OCP_RELEASE=4.12.47
    export LOCAL_REGISTRY=dc1fbreg01.redprodc1.firebolt.para.in:8443
    export LOCAL_REPOSITORY=ocp4/openshift4
    export REG_CREDS=/root/quay-secret.json
    export PRODUCT_REPO=openshift-release-dev
    export RELEASE_NAME=ocp-release
    export ARCHITECTURE=x86_64
    export GODEBUG=x509ignoreCN=0
    export REMOVABLE_MEDIA_PATH=/ocpregistry/ocp-base-images

    [root@dc1fbreg01 ~]# source openshift-vars.sh 


## 2.3. Mirror OCP 4.12 Images to Quay Mirror Registry

Download and Install oc-mirror cli command line tool to use the plugin to download images.

    [root@dc1fbreg01 ~]# chmod a+x /usr/bin/oc-mirror

Pushing OCP-Base-Images

    [root@dc1fbreg01 ~]# oc adm release mirror -a ${LOCAL_SECRET_JSON} --to-dir=${REMOVABLE_MEDIA_PATH}/mirror quay.io/${PRODUCT_REPO}/${RELEASE_NAME}:${OCP_RELEASE}-${ARCHITECTURE}
    
    [root@dc1fbreg01 ~]# oc image mirror -a ${REG_CREDS} --from-dir=${REMOVABLE_MEDIA_PATH}/mirror "file://openshift/release:${OCP_RELEASE}*" ${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}

    [root@dc1fbreg01 ~]# oc adm release extract -a ${LOCAL_SECRET_JSON} --command=openshift-install "${LOCAL_REGISTRY}/${LOCAL_REPOSITORY}:${OCP_RELEASE}-${ARCHITECTURE}"


Mirror the version images to the internal container registry

    [root@dc1fbreg01 ~]# oc-mirror version


## 8. Removing the kubeadmin user

After you define an identity provider and create a new cluster-admin user, you can remove the kubeadmin to improve cluster security.


> **[!WARNING]**
> If you follow this procedure before another user is a cluster-admin, then OpenShift Container Platform must be reinstalled. It is not possible to undo this command.

### Prerequisites

* You must have configured at least one identity provider.
* You must have added the cluster-admin role to a user.
* You must be logged in as an administrator.

Retrieve the kubeadmin secret details as shown below
    
    [root@dc1fbreg01 ~]# oc get secrets kubeadmin -n kube-system
    NAME        TYPE     DATA   AGE
    kubeadmin   Opaque   1      97d


Remove the kubeadmin secret as shown below


    [root@dc1fbreg01 ~]# oc delete secrets kubeadmin -n kube-system
    secret "kubeadmin" deleted


Verify if the kubeadmin secret no more exists as shown below
    
    [root@dc1fbreg01 ~]# oc get secrets kubeadmin -n kube-system
    Error from server (NotFound): secrets "kubeadmin" not found